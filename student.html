<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç­¾åˆ°é¡µé¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .container { 
            width: 100%; 
            max-width: 500px; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            overflow: hidden; 
        }
        .header { 
            background: #667eea; 
            color: white; 
            padding: 25px 20px; 
            text-align: center; 
        }
        .header h1 { 
            font-size: 24px; 
            margin-bottom: 5px; 
        }
        .header p { 
            opacity: 0.9; 
            font-size: 14px; 
        }
        .form-container { 
            padding: 30px; 
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333; 
        }
        input { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e1e5ee; 
            border-radius: 10px; 
            font-size: 16px; 
            transition: all 0.3s; 
        }
        input:focus { 
            border-color: #667eea; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(102,126,234,0.2); 
        }
        button { 
            width: 100%; 
            padding: 15px; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.3s; 
        }
        button:hover { 
            background: #5a6fd8; 
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .message { 
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 20px; 
            text-align: center; 
            display: none; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .instruction-hint { 
            background: #e3f2fd; 
            border: 1px solid #bbdefb; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            font-size: 14px; 
        }
        .hint-title { 
            font-weight: bold; 
            color: #1976d2; 
            margin-bottom: 5px; 
        }
        .device-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            display: none;
        }
        
        /* GitHubåŒæ­¥çŠ¶æ€ */
        .sync-status {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sync-status.syncing {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1976d2;
        }
        .sync-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .sync-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* è¿‡æœŸé¡µé¢æ ·å¼ */
        .expired-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .expired-content {
            background: white;
            color: #333;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }
        .expired-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .expired-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        .expired-message {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .expired-action {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        /* è®¾å¤‡é™åˆ¶é¡µé¢ */
        .device-limit-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .device-limit-content {
            background: white;
            color: #333;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }
        .device-limit-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .device-limit-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        .device-limit-message {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .countdown {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }
        
        /* å†å²è®°å½•æŒ‰é’® */
        .history-btn {
            margin-top: 15px;
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px;
        }
        .history-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* å†å²è®°å½•å¼¹çª— */
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .history-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .history-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-header h2 {
            font-size: 20px;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: auto;
            padding: 0;
        }
        .history-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-select {
            padding: 10px;
            border: 2px solid #e1e5ee;
            border-radius: 8px;
            font-size: 14px;
            flex-grow: 1;
            min-width: 150px;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5ee;
        }
        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .history-table tr:hover {
            background: #f8f9fa;
        }
        .status-success {
            color: #28a745;
            font-weight: 600;
        }
        .status-warning {
            color: #ffc107;
            font-weight: 600;
        }
        .status-suspicious {
            color: #dc3545;
            font-weight: 600;
        }
        .no-records {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        /* æäº¤æ¬¡æ•°æç¤º */
        .attempts-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .attempts-critical {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- è®¾å¤‡é™åˆ¶é¡µé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="deviceLimitPage" class="device-limit-container" style="display: none;">
        <div class="device-limit-content">
            <div class="device-limit-icon">ğŸš«</div>
            <h2 class="device-limit-title">è®¾å¤‡ç­¾åˆ°é™åˆ¶</h2>
            <p class="device-limit-message">æ£€æµ‹åˆ°æ‚¨å·²ä½¿ç”¨æ­¤è®¾å¤‡å®Œæˆç­¾åˆ°ï¼Œè¯·å‹¿é‡å¤æäº¤ã€‚</p>
            <div class="countdown" id="countdown">30ç§’åå¯é‡æ–°å°è¯•</div>
            <div class="expired-action">
                å¦‚éœ€å¸®åŠ©ï¼Œè¯·è”ç³»è€å¸ˆæˆ–ç®¡ç†å‘˜
            </div>
        </div>
    </div>

    <!-- è¿‡æœŸé¡µé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="expiredPage" class="expired-container" style="display: none;">
        <div class="expired-content">
            <div class="expired-icon">â°</div>
            <h2 class="expired-title">äºŒç»´ç å·²è¿‡æœŸ</h2>
            <p class="expired-message">å½“å‰äºŒç»´ç å·²è¶…è¿‡æœ‰æ•ˆæœŸï¼Œè¯·é‡æ–°æ‰«æè·å–æœ€æ–°äºŒç»´ç ã€‚</p>
            <div class="expired-action">
                å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»è€å¸ˆæˆ–ç®¡ç†å‘˜
            </div>
        </div>
    </div>

    <!-- æ­£å¸¸ç­¾åˆ°é¡µé¢ -->
    <div id="signinPage" class="container">
        <div class="header">
            <h1>ğŸ“ å­¦ç”Ÿç­¾åˆ°</h1>
            <p>è¯·å¡«å†™ä¿¡æ¯å®Œæˆç­¾åˆ°</p>
        </div>
        
        <div class="form-container">
            <!-- GitHubåŒæ­¥çŠ¶æ€ -->
            <div class="sync-status" id="syncStatus">
                <i class="fas fa-sync"></i>
                <span>æ­£åœ¨ä»GitHubåŠ è½½æ•°æ®...</span>
            </div>

            <div class="instruction-hint">
                <div class="hint-title">ğŸ“ ç­¾åˆ°è¯´æ˜ï¼š</div>
                <div>åŒä¸€è®¾å¤‡ä¸èƒ½é‡å¤æäº¤ï¼Œç­¾åˆ°ä¿¡æ¯é”™è¯¯æ— æ³•æäº¤</div>
            </div>

            <div class="device-warning" id="deviceWarning">
                âš ï¸ æ£€æµ‹åˆ°æ­¤è®¾å¤‡å·²ç”¨äºç­¾åˆ°ï¼Œè¯·å‹¿é‡å¤æäº¤
            </div>
            
            <!-- æäº¤æ¬¡æ•°è­¦å‘Š -->
            <div class="attempts-warning" id="attemptsWarning">
                âš ï¸ è¯·è®¤çœŸæ ¸å¯¹ä¿¡æ¯ï¼Œæœ¬æ¬¡æäº¤ä¿¡æ¯å¦‚æœé”™è¯¯ï¼Œ20åˆ†é’Ÿå†…å°†æ— æ³•æäº¤ï¼Œå‰ä¸¤æ¬¡æäº¤ä¿¡æ¯å·²è¢«æ ‡è®°
            </div>
            
            <div class="attempts-critical" id="attemptsCritical">
                ğŸš« ä¿¡æ¯é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œ20åˆ†é’Ÿå†…æ— æ³•å†æ¬¡æäº¤
            </div>
            
            <form id="signinForm">
                <div class="form-group">
                    <label for="studentId">å­¦å·</label>
                    <input type="text" id="studentId" name="studentId" placeholder="è¯·è¾“å…¥æ‚¨çš„å­¦å·" required>
                </div>
                
                <div class="form-group">
                    <label for="name">å§“å</label>
                    <input type="text" id="name" name="name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                </div>
                
                <div class="form-group">
                    <label for="class">ç­çº§</label>
                    <input type="text" id="class" name="class" placeholder="è¯·è¾“å…¥æ‚¨çš„ç­çº§" required>
                </div>
                
                <div class="form-group">
                    <label for="specialCode">ç‰¹æ®ŠæŒ‡ä»¤</label>
                    <input type="text" id="specialCode" name="specialCode" placeholder="è¯·è¾“å…¥ç‰¹æ®ŠæŒ‡ä»¤" required>
                </div>
                
                <input type="hidden" id="signId" name="signId">
                
                <button type="submit" id="submitBtn">æäº¤ç­¾åˆ°</button>
            </form>
            
            <button class="history-btn" id="historyBtn">ğŸ“‹ æŸ¥çœ‹ç­¾åˆ°å†å²</button>
            
            <div class="message" id="message"></div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div id="historyModal" class="history-modal">
        <div class="history-content">
            <div class="history-header">
                <h2>ğŸ“‹ ç­¾åˆ°å†å²è®°å½•</h2>
                <button class="close-btn" id="closeHistoryBtn">Ã—</button>
            </div>
            <div class="history-body">
                <div class="history-filters">
                    <select id="filterStatus" class="filter-select">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="success">ç­¾åˆ°æˆåŠŸ</option>
                        <option value="warning">å·²ç­¾åˆ°</option>
                        <option value="suspicious">å¯ç–‘è®°å½•</option>
                        <option value="error">ä¿¡æ¯é”™è¯¯</option>
                    </select>
                    <select id="filterClass" class="filter-select">
                        <option value="">æ‰€æœ‰ç­çº§</option>
                    </select>
                    <select id="sortBy" class="filter-select">
                        <option value="newest">æœ€æ–°ä¼˜å…ˆ</option>
                        <option value="oldest">æœ€æ—©ä¼˜å…ˆ</option>
                    </select>
                </div>
                <div id="historyTableContainer">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ—¶é—´</th>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>ç­çº§</th>
                                <th>çŠ¶æ€</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- å†å²è®°å½•å°†åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                    <div id="noRecordsMessage" class="no-records" style="display: none;">
                        <p>æš‚æ— ç­¾åˆ°è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // ==================== GitHubé…ç½® ====================
        const GITHUB_CONFIG = {
            owner: 'so-far-away0408',  // ä½ çš„GitHubç”¨æˆ·å
            repo: 'signin_system',     // ä½ çš„ä»“åº“å
            branch: 'main'
        };

        // ==================== GitHubæ•°æ®é›†æˆ ====================

        // ä»GitHubè·å–æ•™å¸ˆç«¯æ•°æ®
        async function loadTeacherData() {
            updateSyncStatus('syncing', 'æ­£åœ¨ä»GitHubåŠ è½½æ•°æ®...');
            
            try {
                // è·å–å­¦ç”Ÿåå•
                const studentListResponse = await fetch(
                    `https://${GITHUB_CONFIG.owner}.github.io/${GITHUB_CONFIG.repo}/data/student_list.json?t=${Date.now()}`
                );
                
                // è·å–ç­¾åˆ°æŒ‡ä»¤
                const instructionResponse = await fetch(
                    `https://${GITHUB_CONFIG.owner}.github.io/${GITHUB_CONFIG.repo}/data/instruction.json?t=${Date.now()}`
                );
                
                let studentListLoaded = false;
                let instructionLoaded = false;

                if (studentListResponse.ok) {
                    const studentList = await studentListResponse.json();
                    if (studentList && Array.isArray(studentList)) {
                        localStorage.setItem('studentList', JSON.stringify(studentList));
                        studentListLoaded = true;
                        console.log('å­¦ç”Ÿåå•åŠ è½½æˆåŠŸ:', studentList.length, 'åå­¦ç”Ÿ');
                    }
                }

                if (instructionResponse.ok) {
                    const instruction = await instructionResponse.json();
                    if (instruction) {
                        localStorage.setItem('teacherSettings', JSON.stringify(instruction));
                        instructionLoaded = true;
                        console.log('ç­¾åˆ°æŒ‡ä»¤åŠ è½½æˆåŠŸ:', instruction);
                    }
                }

                if (studentListLoaded && instructionLoaded) {
                    updateSyncStatus('success', 'æ•°æ®åŠ è½½æˆåŠŸ');
                    setTimeout(() => {
                        document.getElementById('syncStatus').style.display = 'none';
                    }, 3000);
                } else {
                    updateSyncStatus('warning', 'éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜');
                }
                
            } catch (error) {
                console.error('ä»GitHubåŠ è½½æ•°æ®å¤±è´¥:', error);
                updateSyncStatus('error', 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜');
            }
        }

        // æäº¤ç­¾åˆ°æ•°æ®åˆ°GitHub
        async function submitSignInToGitHub(signData) {
            try {
                // å‡†å¤‡æäº¤æ•°æ®
                const submissionData = {
                    type: 'student_signin',
                    data: signData,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId()
                };

                // åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨GitHub API
                // ç”±äºå‰ç«¯ç›´æ¥è°ƒç”¨GitHub APIéœ€è¦tokenï¼Œè¿™é‡Œæˆ‘ä»¬æ¨¡æ‹ŸæˆåŠŸ
                // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
                
                console.log('å‡†å¤‡æäº¤ç­¾åˆ°æ•°æ®åˆ°GitHub:', submissionData);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                let records = JSON.parse(localStorage.getItem('signinRecords')) || [];
                records.push(signData);
                localStorage.setItem('signinRecords', JSON.stringify(records));
                
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨GitHub API
                // å¯ä»¥é€šè¿‡GitHub Issuesã€GitHub Actions webhookç­‰æ–¹å¼æäº¤æ•°æ®
                
                return true;
                
            } catch (error) {
                console.error('æäº¤åˆ°GitHubå¤±è´¥:', error);
                // å³ä½¿GitHubæäº¤å¤±è´¥ï¼Œä¹Ÿä¿å­˜åˆ°æœ¬åœ°
                let records = JSON.parse(localStorage.getItem('signinRecords')) || [];
                records.push(signData);
                localStorage.setItem('signinRecords', JSON.stringify(records));
                return false;
            }
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('syncStatus');
            syncElement.className = `sync-status ${status}`;
            
            let icon = 'fa-sync';
            if (status === 'success') icon = 'fa-check-circle';
            else if (status === 'error') icon = 'fa-exclamation-triangle';
            else if (status === 'warning') icon = 'fa-exclamation-circle';
            
            syncElement.innerHTML = `
                <i class="fas ${icon} ${status === 'syncing' ? 'fa-spin' : ''}"></i>
                <span>${message}</span>
            `;
        }

        // ==================== åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ ====================

        // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
        function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.language,
                navigator.hardwareConcurrency || 'unknown',
                screen.width + 'x' + screen.height,
                screen.colorDepth + 'bit',
                new Date().getTimezoneOffset(),
                navigator.platform,
                navigator.maxTouchPoints || 'unknown'
            ];
            
            let hash = 0;
            const str = components.join('|');
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash).toString(16) + '_' + navigator.userAgent.length;
        }

        // è·å–æˆ–åˆ›å»ºè®¾å¤‡ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('studentDeviceId');
            if (!deviceId) {
                deviceId = generateDeviceFingerprint();
                localStorage.setItem('studentDeviceId', deviceId);
            }
            return deviceId;
        }

        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨20åˆ†é’Ÿå†…å·²æˆåŠŸç­¾åˆ°
        function checkDeviceRecentSignIn() {
            const deviceId = getDeviceId();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            const twentyMinutesAgo = Date.now() - (20 * 60 * 1000);
            
            const recentSuccess = records.some(record => {
                const recordTime = new Date(record.timestamp).getTime();
                return record.deviceId === deviceId && 
                       record.status === 'success' && 
                       recordTime > twentyMinutesAgo;
            });
            
            return recentSuccess;
        }

        // æ£€æŸ¥è®¾å¤‡é”™è¯¯æäº¤æ¬¡æ•°
        function checkDeviceErrorAttempts() {
            const deviceId = getDeviceId();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            const twentyMinutesAgo = Date.now() - (20 * 60 * 1000);
            
            const errorAttempts = records.filter(record => {
                const recordTime = new Date(record.timestamp).getTime();
                return record.deviceId === deviceId && 
                       record.status === 'error' && 
                       recordTime > twentyMinutesAgo;
            }).length;
            
            return errorAttempts;
        }

        // æ£€æŸ¥è®¾å¤‡å†·å´æ—¶é—´
        function checkDeviceCooldown() {
            const lastAttempt = localStorage.getItem('lastDeviceAttempt');
            if (!lastAttempt) return false;
            
            const cooldownTime = 30 * 1000;
            const timeDiff = Date.now() - parseInt(lastAttempt);
            
            return timeDiff < cooldownTime;
        }

        // æ›´æ–°å†·å´æ—¶é—´æ˜¾ç¤º
        function updateCooldownDisplay() {
            const lastAttempt = localStorage.getItem('lastDeviceAttempt');
            if (!lastAttempt) return;
            
            const cooldownTime = 30 * 1000;
            const timeDiff = Date.now() - parseInt(lastAttempt);
            const remaining = Math.ceil((cooldownTime - timeDiff) / 1000);
            
            if (remaining > 0) {
                document.getElementById('countdown').textContent = `${remaining}ç§’åå¯é‡æ–°å°è¯•`;
                setTimeout(updateCooldownDisplay, 1000);
            } else {
                document.getElementById('countdown').textContent = 'å¯é‡æ–°å°è¯•ç­¾åˆ°';
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡é™åˆ¶é¡µé¢
        function showDeviceLimitPage() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('expiredPage').style.display = 'none';
            document.getElementById('deviceLimitPage').style.display = 'flex';
            
            updateCooldownDisplay();
            
            setTimeout(() => {
                document.getElementById('deviceLimitPage').style.display = 'none';
                document.getElementById('signinPage').style.display = 'block';
                localStorage.removeItem('lastDeviceAttempt');
            }, 30000);
        }

        // æ£€æŸ¥URLå‚æ•°ä¸­çš„è¿‡æœŸæ—¶é—´
        function checkQRCodeExpiry() {
            const urlParams = new URLSearchParams(window.location.search);
            const expireTime = urlParams.get('expire');
            
            if (expireTime) {
                const currentTime = Date.now();
                if (currentTime > parseInt(expireTime)) {
                    document.getElementById('signinPage').style.display = 'none';
                    document.getElementById('expiredPage').style.display = 'flex';
                    return true;
                }
            }
            return false;
        }
        
        // è·å–æ•™å¸ˆç«¯è®¾ç½®çš„å­¦ç”Ÿåå•
        function getStudentList() {
            const storedList = JSON.parse(localStorage.getItem('studentList'));
            return storedList && storedList.length > 0 ? storedList : [];
        }
        
        // è·å–æ•™å¸ˆç«¯è®¾ç½®
        function getTeacherSettings() {
            return JSON.parse(localStorage.getItem('teacherSettings')) || {
                instructionPattern: "å­¦å·X",
                randomValue: "2024"
            };
        }
        
        // éªŒè¯å­¦ç”Ÿä¿¡æ¯æ˜¯å¦åœ¨åå•ä¸­
        function validateStudentInfo(studentId, name, className) {
            const studentList = getStudentList();
            return studentList.some(student => 
                student.studentId === studentId && 
                student.name === name && 
                student.className === className
            );
        }
        
        // æ£€æŸ¥åŒä¸€å¤©æ˜¯å¦å·²ç»ç­¾åˆ°è¿‡
        function checkDailySignIn(studentId) {
            const today = new Date().toDateString();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            
            const todaySignIn = records.find(record => {
                const recordDate = new Date(record.timestamp).toDateString();
                return record.studentId === studentId && recordDate === today;
            });
            
            return !!todaySignIn;
        }

        // æ£€æŸ¥è®¾å¤‡è®°å½•
        function checkDeviceRecords(studentId) {
            const deviceId = getDeviceId();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            
            const deviceUsed = records.some(record => 
                record.deviceId === deviceId && record.studentId !== studentId
            );
            
            return deviceUsed;
        }
        
        // æ›´æ–°æäº¤æ¬¡æ•°è­¦å‘Šæ˜¾ç¤º
        function updateAttemptsWarning() {
            const errorAttempts = checkDeviceErrorAttempts();
            const warningElement = document.getElementById('attemptsWarning');
            const criticalElement = document.getElementById('attemptsCritical');
            
            warningElement.style.display = 'none';
            criticalElement.style.display = 'none';
            
            if (errorAttempts >= 2) {
                criticalElement.style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'æäº¤å·²ç¦ç”¨';
            } else if (errorAttempts === 1) {
                warningElement.style.display = 'block';
            }
        }
        
        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('signinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value;
            const name = document.getElementById('name').value;
            const className = document.getElementById('class').value;
            const specialCode = document.getElementById('specialCode').value;
            const signId = document.getElementById('signId').value;
            
            if (!studentId || !name || !className || !specialCode) {
                showMessage('âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡å†·å´æ—¶é—´
            if (checkDeviceCooldown()) {
                showDeviceLimitPage();
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨20åˆ†é’Ÿå†…å·²æˆåŠŸç­¾åˆ°
            if (checkDeviceRecentSignIn()) {
                showMessage('âŒ æ­¤è®¾å¤‡20åˆ†é’Ÿå†…å·²å®Œæˆç­¾åˆ°ï¼Œæ— æ³•é‡å¤æäº¤', 'error');
                localStorage.setItem('lastDeviceAttempt', Date.now().toString());
                return;
            }

            // æ£€æŸ¥è®¾å¤‡é”™è¯¯æäº¤æ¬¡æ•°
            const errorAttempts = checkDeviceErrorAttempts();
            if (errorAttempts >= 2) {
                showMessage('ğŸš« ä¿¡æ¯é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œ20åˆ†é’Ÿå†…æ— æ³•å†æ¬¡æäº¤', 'error');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç”¨äºå…¶ä»–å­¦ç”Ÿ
            if (checkDeviceRecords(studentId)) {
                showMessage('âš ï¸ æ­¤è®¾å¤‡å·²ç”¨äºå…¶ä»–å­¦ç”Ÿç­¾åˆ°ï¼Œæ“ä½œå·²è¢«è®°å½•', 'warning');
                localStorage.setItem('lastDeviceAttempt', Date.now().toString());
                
                const record = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    signId: signId,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    status: 'suspicious',
                    reason: 'è®¾å¤‡é‡å¤ä½¿ç”¨'
                };
                
                // æäº¤åˆ°GitHub
                await submitSignInToGitHub(record);
                return;
            }
            
            // éªŒè¯å­¦ç”Ÿä¿¡æ¯æ˜¯å¦åœ¨åå•ä¸­
            if (!validateStudentInfo(studentId, name, className)) {
                const errorRecord = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    signId: signId,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    status: 'error',
                    reason: 'ä¿¡æ¯ä¸åŒ¹é…'
                };
                
                // æäº¤åˆ°GitHub
                await submitSignInToGitHub(errorRecord);
                
                showMessage('âŒ ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°æäº¤', 'error');
                updateAttemptsWarning();
                return;
            }
            
            // æ£€æŸ¥åŒä¸€å¤©æ˜¯å¦å·²ç»ç­¾åˆ°è¿‡
            if (checkDailySignIn(studentId)) {
                showMessage('âš ï¸ æ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†', 'warning');
                return;
            }
            
            const settings = getTeacherSettings();
            const pattern = settings.instructionPattern.replace(/â€œ([^â€]*)â€/g, '$1');
            const expectedCode = pattern.replace('X', settings.randomValue);
            
            if (specialCode === expectedCode) {
                const record = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    signId: signId,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    status: 'success'
                };
                
                // æäº¤åˆ°GitHub
                const submitted = await submitSignInToGitHub(record);
                if (submitted) {
                    showMessage(`âœ… ç­¾åˆ°æˆåŠŸï¼æ¬¢è¿ ${name} åŒå­¦`, 'success');
                    document.getElementById('signinForm').reset();
                    document.getElementById('submitBtn').disabled = true;
                    
                    setTimeout(() => {
                        document.getElementById('message').style.display = 'none';
                        document.getElementById('submitBtn').disabled = false;
                    }, 3000);
                }
            } else {
                showMessage('âŒ æäº¤å¤±è´¥ï¼ç‰¹æ®ŠæŒ‡ä»¤ä¸æ­£ç¡®', 'error');
            }
        });
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            if (checkQRCodeExpiry()) {
                return;
            }

            // ä»GitHubåŠ è½½æ•°æ®
            await loadTeacherData();

            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç­¾åˆ°
            if (checkDeviceRecentSignIn()) {
                document.getElementById('deviceWarning').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ç”Ÿåå•
            const studentList = getStudentList();
            if (studentList.length === 0) {
                showMessage('âš ï¸ ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·è”ç³»è€å¸ˆå¯¼å…¥å­¦ç”Ÿåå•', 'warning');
            }

            // æ£€æŸ¥è®¾å¤‡å†·å´æ—¶é—´
            if (checkDeviceCooldown()) {
                showDeviceLimitPage();
            }
            
            // æ›´æ–°æäº¤æ¬¡æ•°è­¦å‘Š
            updateAttemptsWarning();
            
            // åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
            initHistoryView();
        };

        // å®æ—¶æ£€æŸ¥è®¾å¤‡çŠ¶æ€
        setInterval(() => {
            if (checkDeviceRecentSignIn()) {
                document.getElementById('deviceWarning').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
            } else {
                document.getElementById('deviceWarning').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'æäº¤ç­¾åˆ°';
            }
            
            updateAttemptsWarning();
        }, 5000);
        
        // å†å²è®°å½•åŠŸèƒ½
        function initHistoryView() {
            document.getElementById('historyBtn').addEventListener('click', function() {
                showHistoryModal();
            });
            
            document.getElementById('closeHistoryBtn').addEventListener('click', function() {
                document.getElementById('historyModal').style.display = 'none';
            });
            
            document.getElementById('filterStatus').addEventListener('change', updateHistoryTable);
            document.getElementById('filterClass').addEventListener('change', updateHistoryTable);
            document.getElementById('sortBy').addEventListener('change', updateHistoryTable);
            
            document.getElementById('historyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        }
        
        function showHistoryModal() {
            document.getElementById('historyModal').style.display = 'flex';
            updateHistoryTable();
        }
        
        function updateHistoryTable() {
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            const filterStatus = document.getElementById('filterStatus').value;
            const filterClass = document.getElementById('filterClass').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filteredRecords = records.filter(record => {
                if (filterStatus && record.status !== filterStatus) return false;
                if (filterClass && record.className !== filterClass) return false;
                return true;
            });
            
            filteredRecords.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                return sortBy === 'newest' ? dateB - dateA : dateA - dateB;
            });
            
            updateClassFilterOptions(records);
            renderHistoryTable(filteredRecords);
        }
        
        function updateClassFilterOptions(records) {
            const classSelect = document.getElementById('filterClass');
            const currentValue = classSelect.value;
            
            const classes = [...new Set(records.map(record => record.className))].filter(c => c);
            
            while (classSelect.children.length > 1) {
                classSelect.removeChild(classSelect.lastChild);
            }
            
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
            
            classSelect.value = currentValue;
        }
        
        function renderHistoryTable(records) {
            const tableBody = document.getElementById('historyTableBody');
            const noRecordsMessage = document.getElementById('noRecordsMessage');
            
            tableBody.innerHTML = '';
            
            if (records.length === 0) {
                tableBody.parentNode.style.display = 'none';
                noRecordsMessage.style.display = 'block';
                return;
            }
            
            tableBody.parentNode.style.display = 'table';
            noRecordsMessage.style.display = 'none';
            
            records.forEach(record => {
                const row = document.createElement('tr');
                const date = new Date(record.timestamp);
                const dateStr = date.toLocaleDateString('zh-CN');
                const timeStr = date.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                let statusText, statusClass;
                switch(record.status) {
                    case 'success':
                        statusText = 'ç­¾åˆ°æˆåŠŸ';
                        statusClass = 'status-success';
                        break;
                    case 'warning':
                        statusText = 'å·²ç­¾åˆ°';
                        statusClass = 'status-warning';
                        break;
                    case 'suspicious':
                        statusText = 'å¯ç–‘è®°å½•';
                        statusClass = 'status-suspicious';
                        break;
                    case 'error':
                        statusText = 'ä¿¡æ¯é”™è¯¯';
                        statusClass = 'status-suspicious';
                        break;
                    default:
                        statusText = 'æœªçŸ¥';
                        statusClass = '';
                }
                
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${timeStr}</td>
                    <td>${record.studentId}</td>
                    <td>${record.name}</td>
                    <td>${record.className}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${record.reason || '-'}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>