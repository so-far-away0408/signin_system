<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç­¾åˆ°é¡µé¢</title>
    <style>
        /* ä¿æŒä½ åŸæœ‰çš„æ‰€æœ‰CSSæ ·å¼ä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        /* ... ä½ åŸæœ‰çš„æ‰€æœ‰CSSæ ·å¼ ... */
    </style>
</head>
<body>
    <!-- ä¿æŒä½ åŸæœ‰çš„HTMLç»“æ„ä¸å˜ -->
    <div id="deviceLimitPage" class="device-limit-container" style="display: none;">
        <!-- ... -->
    </div>

    <div id="expiredPage" class="expired-container" style="display: none;">
        <!-- ... -->
    </div>

    <div id="signinPage" class="container">
        <!-- ... -->
    </div>

    <div id="historyModal" class="history-modal">
        <!-- ... -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // ==================== ä¿®å¤çš„GitHubé…ç½® ====================
        const GITHUB_CONFIG = {
            owner: 'so-far-away0408',
            repo: 'signin_system',
            branch: 'main'
        };

        // ==================== ä¿®å¤çš„æ•°æ®åŠ è½½å‡½æ•° ====================
        async function loadTeacherData() {
            updateSyncStatus('syncing', 'æ­£åœ¨ä»GitHubåŠ è½½æ•°æ®...');
            
            try {
                console.log('å¼€å§‹ä»GitHubåŠ è½½æ•°æ®...');
                
                // æ–¹æ³•1: ç›´æ¥è®¿é—®GitHub Pages
                const studentListUrl = `https://${GITHUB_CONFIG.owner}.github.io/${GITHUB_CONFIG.repo}/data/student_list.json`;
                const instructionUrl = `https://${GITHUB_CONFIG.owner}.github.io/${GITHUB_CONFIG.repo}/data/instruction.json`;
                
                console.log('å°è¯•URL:', studentListUrl);
                
                // ä½¿ç”¨fetchå¹¶è®¾ç½®è¶…æ—¶
                const fetchWithTimeout = (url, timeout = 10000) => {
                    return Promise.race([
                        fetch(url, { 
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout)
                        )
                    ]);
                };

                let studentListLoaded = false;
                let instructionLoaded = false;

                try {
                    const studentListResponse = await fetchWithTimeout(studentListUrl + '?t=' + Date.now());
                    if (studentListResponse.ok) {
                        const studentList = await studentListResponse.json();
                        if (studentList && Array.isArray(studentList)) {
                            localStorage.setItem('studentList', JSON.stringify(studentList));
                            studentListLoaded = true;
                            console.log('å­¦ç”Ÿåå•åŠ è½½æˆåŠŸ:', studentList.length, 'åå­¦ç”Ÿ');
                        }
                    } else {
                        console.warn('å­¦ç”Ÿåå•åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€:', studentListResponse.status);
                    }
                } catch (error) {
                    console.warn('å­¦ç”Ÿåå•åŠ è½½é”™è¯¯:', error.message);
                }

                try {
                    const instructionResponse = await fetchWithTimeout(instructionUrl + '?t=' + Date.now());
                    if (instructionResponse.ok) {
                        const instruction = await instructionResponse.json();
                        if (instruction) {
                            localStorage.setItem('teacherSettings', JSON.stringify(instruction));
                            instructionLoaded = true;
                            console.log('ç­¾åˆ°æŒ‡ä»¤åŠ è½½æˆåŠŸ:', instruction);
                        }
                    } else {
                        console.warn('ç­¾åˆ°æŒ‡ä»¤åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€:', instructionResponse.status);
                    }
                } catch (error) {
                    console.warn('ç­¾åˆ°æŒ‡ä»¤åŠ è½½é”™è¯¯:', error.message);
                }

                // å¦‚æœGitHubåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
                if (!studentListLoaded || !instructionLoaded) {
                    console.log('GitHubåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®...');
                    await loadFallbackData();
                } else {
                    updateSyncStatus('success', 'æ•°æ®åŠ è½½æˆåŠŸ');
                    setTimeout(() => {
                        document.getElementById('syncStatus').style.display = 'none';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å®Œå…¨å¤±è´¥:', error);
                await loadFallbackData();
            }
        }

        // å¤‡ç”¨æ•°æ®åŠ è½½
        async function loadFallbackData() {
            console.log('åŠ è½½å¤‡ç”¨æ•°æ®...');
            
            // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æ•°æ®
            const localStudentList = localStorage.getItem('studentList');
            const localSettings = localStorage.getItem('teacherSettings');
            
            if (!localStudentList) {
                // åˆ›å»ºæ¼”ç¤ºæ•°æ®
                const demoStudents = [
                    { studentId: "3240112001", name: "å¼ ä¸‰", className: "æå“243" },
                    { studentId: "3240112002", name: "æå››", className: "æå“243" },
                    { studentId: "3240112003", name: "ç‹äº”", className: "æå“243" },
                    { studentId: "3240112004", name: "èµµå…­", className: "æ233" },
                    { studentId: "3240112005", name: "é’±ä¸ƒ", className: "æ233" }
                ];
                localStorage.setItem('studentList', JSON.stringify(demoStudents));
            }
            
            if (!localSettings) {
                const demoInstruction = {
                    instructionPattern: "å­¦å·X",
                    randomValue: "2024"
                };
                localStorage.setItem('teacherSettings', JSON.stringify(demoInstruction));
            }
            
            updateSyncStatus('warning', 'ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼ŒGitHubè¿æ¥å¤±è´¥');
            setTimeout(() => {
                document.getElementById('syncStatus').style.display = 'none';
            }, 5000);
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('syncStatus');
            if (!syncElement) return;
            
            syncElement.className = `sync-status ${status}`;
            
            let icon = 'fa-sync';
            if (status === 'success') icon = 'fa-check-circle';
            else if (status === 'error') icon = 'fa-exclamation-triangle';
            else if (status === 'warning') icon = 'fa-exclamation-circle';
            
            syncElement.innerHTML = `
                <i class="fas ${icon} ${status === 'syncing' ? 'fa-spin' : ''}"></i>
                <span>${message}</span>
            `;
        }

        // ==================== ä½ åŸæœ‰çš„å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ ====================
        // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
        function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.language,
                navigator.hardwareConcurrency || 'unknown',
                screen.width + 'x' + screen.height,
                screen.colorDepth + 'bit',
                new Date().getTimezoneOffset(),
                navigator.platform,
                navigator.maxTouchPoints || 'unknown'
            ];
            
            let hash = 0;
            const str = components.join('|');
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash).toString(16) + '_' + navigator.userAgent.length;
        }

        // è·å–æˆ–åˆ›å»ºè®¾å¤‡ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('studentDeviceId');
            if (!deviceId) {
                deviceId = generateDeviceFingerprint();
                localStorage.setItem('studentDeviceId', deviceId);
            }
            return deviceId;
        }

        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨20åˆ†é’Ÿå†…å·²æˆåŠŸç­¾åˆ°
        function checkDeviceRecentSignIn() {
            const deviceId = getDeviceId();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            const twentyMinutesAgo = Date.now() - (20 * 60 * 1000);
            
            const recentSuccess = records.some(record => {
                const recordTime = new Date(record.timestamp).getTime();
                return record.deviceId === deviceId && 
                       record.status === 'success' && 
                       recordTime > twentyMinutesAgo;
            });
            
            return recentSuccess;
        }

        // æ£€æŸ¥è®¾å¤‡é”™è¯¯æäº¤æ¬¡æ•°
        function checkDeviceErrorAttempts() {
            const deviceId = getDeviceId();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            const twentyMinutesAgo = Date.now() - (20 * 60 * 1000);
            
            const errorAttempts = records.filter(record => {
                const recordTime = new Date(record.timestamp).getTime();
                return record.deviceId === deviceId && 
                       record.status === 'error' && 
                       recordTime > twentyMinutesAgo;
            }).length;
            
            return errorAttempts;
        }

        // æ£€æŸ¥è®¾å¤‡å†·å´æ—¶é—´
        function checkDeviceCooldown() {
            const lastAttempt = localStorage.getItem('lastDeviceAttempt');
            if (!lastAttempt) return false;
            
            const cooldownTime = 30 * 1000;
            const timeDiff = Date.now() - parseInt(lastAttempt);
            
            return timeDiff < cooldownTime;
        }

        // æ›´æ–°å†·å´æ—¶é—´æ˜¾ç¤º
        function updateCooldownDisplay() {
            const lastAttempt = localStorage.getItem('lastDeviceAttempt');
            if (!lastAttempt) return;
            
            const cooldownTime = 30 * 1000;
            const timeDiff = Date.now() - parseInt(lastAttempt);
            const remaining = Math.ceil((cooldownTime - timeDiff) / 1000);
            
            if (remaining > 0) {
                document.getElementById('countdown').textContent = `${remaining}ç§’åå¯é‡æ–°å°è¯•`;
                setTimeout(updateCooldownDisplay, 1000);
            } else {
                document.getElementById('countdown').textContent = 'å¯é‡æ–°å°è¯•ç­¾åˆ°';
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡é™åˆ¶é¡µé¢
        function showDeviceLimitPage() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('expiredPage').style.display = 'none';
            document.getElementById('deviceLimitPage').style.display = 'flex';
            
            updateCooldownDisplay();
            
            setTimeout(() => {
                document.getElementById('deviceLimitPage').style.display = 'none';
                document.getElementById('signinPage').style.display = 'block';
                localStorage.removeItem('lastDeviceAttempt');
            }, 30000);
        }

        // æ£€æŸ¥URLå‚æ•°ä¸­çš„è¿‡æœŸæ—¶é—´
        function checkQRCodeExpiry() {
            const urlParams = new URLSearchParams(window.location.search);
            const expireTime = urlParams.get('expire');
            
            if (expireTime) {
                const currentTime = Date.now();
                if (currentTime > parseInt(expireTime)) {
                    document.getElementById('signinPage').style.display = 'none';
                    document.getElementById('expiredPage').style.display = 'flex';
                    return true;
                }
            }
            return false;
        }
        
        // è·å–æ•™å¸ˆç«¯è®¾ç½®çš„å­¦ç”Ÿåå•
        function getStudentList() {
            const storedList = JSON.parse(localStorage.getItem('studentList'));
            return storedList && storedList.length > 0 ? storedList : [];
        }
        
        // è·å–æ•™å¸ˆç«¯è®¾ç½®
        function getTeacherSettings() {
            return JSON.parse(localStorage.getItem('teacherSettings')) || {
                instructionPattern: "å­¦å·X",
                randomValue: "2024"
            };
        }
        
        // éªŒè¯å­¦ç”Ÿä¿¡æ¯æ˜¯å¦åœ¨åå•ä¸­
        function validateStudentInfo(studentId, name, className) {
            const studentList = getStudentList();
            return studentList.some(student => 
                student.studentId === studentId && 
                student.name === name && 
                student.className === className
            );
        }
        
        // æ£€æŸ¥åŒä¸€å¤©æ˜¯å¦å·²ç»ç­¾åˆ°è¿‡
        function checkDailySignIn(studentId) {
            const today = new Date().toDateString();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            
            const todaySignIn = records.find(record => {
                const recordDate = new Date(record.timestamp).toDateString();
                return record.studentId === studentId && recordDate === today;
            });
            
            return !!todaySignIn;
        }

        // æ£€æŸ¥è®¾å¤‡è®°å½•
        function checkDeviceRecords(studentId) {
            const deviceId = getDeviceId();
            const records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            
            const deviceUsed = records.some(record => 
                record.deviceId === deviceId && record.studentId !== studentId
            );
            
            return deviceUsed;
        }
        
        // æ›´æ–°æäº¤æ¬¡æ•°è­¦å‘Šæ˜¾ç¤º
        function updateAttemptsWarning() {
            const errorAttempts = checkDeviceErrorAttempts();
            const warningElement = document.getElementById('attemptsWarning');
            const criticalElement = document.getElementById('attemptsCritical');
            
            if (warningElement) warningElement.style.display = 'none';
            if (criticalElement) criticalElement.style.display = 'none';
            
            if (errorAttempts >= 2) {
                if (criticalElement) criticalElement.style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'æäº¤å·²ç¦ç”¨';
            } else if (errorAttempts === 1) {
                if (warningElement) warningElement.style.display = 'block';
            }
        }
        
        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('signinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value;
            const name = document.getElementById('name').value;
            const className = document.getElementById('class').value;
            const specialCode = document.getElementById('specialCode').value;
            const signId = document.getElementById('signId').value;
            
            if (!studentId || !name || !className || !specialCode) {
                showMessage('âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡å†·å´æ—¶é—´
            if (checkDeviceCooldown()) {
                showDeviceLimitPage();
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨20åˆ†é’Ÿå†…å·²æˆåŠŸç­¾åˆ°
            if (checkDeviceRecentSignIn()) {
                showMessage('âŒ æ­¤è®¾å¤‡20åˆ†é’Ÿå†…å·²å®Œæˆç­¾åˆ°ï¼Œæ— æ³•é‡å¤æäº¤', 'error');
                localStorage.setItem('lastDeviceAttempt', Date.now().toString());
                return;
            }

            // æ£€æŸ¥è®¾å¤‡é”™è¯¯æäº¤æ¬¡æ•°
            const errorAttempts = checkDeviceErrorAttempts();
            if (errorAttempts >= 2) {
                showMessage('ğŸš« ä¿¡æ¯é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œ20åˆ†é’Ÿå†…æ— æ³•å†æ¬¡æäº¤', 'error');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç”¨äºå…¶ä»–å­¦ç”Ÿ
            if (checkDeviceRecords(studentId)) {
                showMessage('âš ï¸ æ­¤è®¾å¤‡å·²ç”¨äºå…¶ä»–å­¦ç”Ÿç­¾åˆ°ï¼Œæ“ä½œå·²è¢«è®°å½•', 'warning');
                localStorage.setItem('lastDeviceAttempt', Date.now().toString());
                
                const record = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    signId: signId,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    status: 'suspicious',
                    reason: 'è®¾å¤‡é‡å¤ä½¿ç”¨'
                };
                
                // ä¿å­˜è®°å½•
                let records = JSON.parse(localStorage.getItem('signinRecords')) || [];
                records.push(record);
                localStorage.setItem('signinRecords', JSON.stringify(records));
                return;
            }
            
            // éªŒè¯å­¦ç”Ÿä¿¡æ¯æ˜¯å¦åœ¨åå•ä¸­
            if (!validateStudentInfo(studentId, name, className)) {
                const errorRecord = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    signId: signId,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    status: 'error',
                    reason: 'ä¿¡æ¯ä¸åŒ¹é…'
                };
                
                // ä¿å­˜é”™è¯¯è®°å½•
                let records = JSON.parse(localStorage.getItem('signinRecords')) || [];
                records.push(errorRecord);
                localStorage.setItem('signinRecords', JSON.stringify(records));
                
                showMessage('âŒ ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°æäº¤', 'error');
                updateAttemptsWarning();
                return;
            }
            
            // æ£€æŸ¥åŒä¸€å¤©æ˜¯å¦å·²ç»ç­¾åˆ°è¿‡
            if (checkDailySignIn(studentId)) {
                showMessage('âš ï¸ æ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†', 'warning');
                return;
            }
            
            const settings = getTeacherSettings();
            const pattern = settings.instructionPattern.replace(/â€œ([^â€]*)â€/g, '$1');
            const expectedCode = pattern.replace('X', settings.randomValue);
            
            if (specialCode === expectedCode) {
                const record = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    signId: signId,
                    timestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    status: 'success'
                };
                
                // ä¿å­˜æˆåŠŸè®°å½•
                let records = JSON.parse(localStorage.getItem('signinRecords')) || [];
                records.push(record);
                localStorage.setItem('signinRecords', JSON.stringify(records));
                
                showMessage(`âœ… ç­¾åˆ°æˆåŠŸï¼æ¬¢è¿ ${name} åŒå­¦`, 'success');
                document.getElementById('signinForm').reset();
                document.getElementById('submitBtn').disabled = true;
                
                setTimeout(() => {
                    document.getElementById('message').style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                }, 3000);
            } else {
                showMessage('âŒ æäº¤å¤±è´¥ï¼ç‰¹æ®ŠæŒ‡ä»¤ä¸æ­£ç¡®', 'error');
            }
        });
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            if (checkQRCodeExpiry()) {
                return;
            }

            // ä»GitHubåŠ è½½æ•°æ®
            await loadTeacherData();

            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç­¾åˆ°
            if (checkDeviceRecentSignIn()) {
                const deviceWarning = document.getElementById('deviceWarning');
                if (deviceWarning) deviceWarning.style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ç”Ÿåå•
            const studentList = getStudentList();
            if (studentList.length === 0) {
                showMessage('âš ï¸ ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·è”ç³»è€å¸ˆå¯¼å…¥å­¦ç”Ÿåå•', 'warning');
            }

            // æ£€æŸ¥è®¾å¤‡å†·å´æ—¶é—´
            if (checkDeviceCooldown()) {
                showDeviceLimitPage();
            }
            
            // æ›´æ–°æäº¤æ¬¡æ•°è­¦å‘Š
            updateAttemptsWarning();
            
            // åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
            initHistoryView();
        };

        // å®æ—¶æ£€æŸ¥è®¾å¤‡çŠ¶æ€
        setInterval(() => {
            if (checkDeviceRecentSignIn()) {
                const deviceWarning = document.getElementById('deviceWarning');
                if (deviceWarning) deviceWarning.style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
            } else {
                const deviceWarning = document.getElementById('deviceWarning');
                if (deviceWarning) deviceWarning.style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'æäº¤ç­¾åˆ°';
            }
            
            updateAttemptsWarning();
        }, 5000);
        
        // å†å²è®°å½•åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰
        function initHistoryView() {
            // ... ä½ åŸæœ‰çš„å†å²è®°å½•åŠŸèƒ½ä»£ç ä¿æŒä¸å˜
        }
    </script>
</body>
</html>
